
Автор:                                          Найденов Е.А.
Дата создания:                            18.05.2006
Дата последней модификации: 12.01.2007

{*******************************************************}
{*****                                                                                 *****}
{***** IBScript Executer - автомат применения скриптов *****}
{*****                                                                                 *****}
{*******************************************************}


/*** НАЗНАЧЕНИЕ ***/

   Программа предназначена для автоматизации процесса тестирования, применения и корректного переименования скриптов.
В основе логики работы программы - считывание настроек из ini-файла.Т.е. ОБЯЗАТЕЛЬНЫМ УСЛОВИЕМ корректной работы 
программы является правильные настройки параметров ini-файла.

/*** НАСТРОЙКИ ***/

   Структура ini-файла должна быть следующей:

[Test Params] - Секция, содержащая настройки локальной станции, на которой будет производиться тестирование скриптов.
    
    User                  - имя пользователя на локальной станции,пытающегося подключиться к копии файла БД
    Server                - тип сервера, обслуживающего подключения к локальной БД
    Password              - пароль пользователя
    ErrorLogDir           - полный путь к каталогу на локальной станции, в котором будут размещаться log-файлы ошибок выполнения скриптов
    DBPathCopyTo          - полный путь к каталогу на локальной станции, в котором будет размещаться копия файла БД для непосредственного тестирования скриптов
    IBEScriptPath         - полный путь к каталогу на локальной станции, в котором находится утилита ibescript.exe для выолнения скриптов (Обычно она лежит в корневом каталоге IBExpert)
    SeparatorChar         - символ-разделитель, используемый при именовании файлов скриптов
    ArchivatorPath        - полный путь к каталогу на локальной станции, в котором находиться архиватор WinRAR.exe
    ErrorScriptChar       - служебный символ, используемый для маркировки скриптов, которые были применены с ошибками
    PrefixCharCount       - количество первых зарезервированных символов в имени скрипта, однозначно идентифицирующих скрипт 
                            (в нашем случае - это дата создания скрипта + его порядковый номер, т.е количество символов в строке "гггг-мм-дд=№№")
    ScriptPathCopyFrom    - полный путь к каталогу с множеством скриптов для тестирования
    DBArchiveFileNamePart - значимая часть имени файла архива БД для формирования маски поиска ( например: для архива с именем "2005-05-21=DONNU=TEST=RESTORE.IB.gz" это будет "RESTORE" )

[DonNU Test] - одна из секций ( в общем случае их может быть несколько ), содержащая настройки для некоторого типа ( бухгалтерия, Днепр и т.д. ) файла БД
    
    User                  - имя пользователя на удалённом компьютере,пытающегося подключиться к файлу БД
    Server                - тип сервера, обслуживающего подключения к удалённой БД
    Password              - пароль пользователя для удалённой БД
    Path                  - полный путь к файлу БД на удалённом компьютере
    KeyExpr               - ключевое выражение - набор символов, однозначно определяющий тип БД; т.е. файлы скриптов, в имени которых будет
                            содержаться эта последовательность символов будут считаться такими, что должны быть применены к данной БД  
    Execute               - параметр логического типа ( допустимые значения: 0,1), определяющий нужно ли применить к данной БД протестированные скрипты
    Rename                - параметр логического типа ( допустимые значения: 0,1), определяющий нужно ли переименовать протестированные скрипты
    FullRename            - параметр логического типа ( допустимые значения: 0,1), определяющий нужно ли полностью переименовать файл скрипта при применении скрипта
    DBPathBackUp          - полный путь к каталогу, содержащему множество подкаталогов с архивами файлов БД и их бекапов ( в нашем случае это полный путь к папке BackUp )
    SystemScript                - абсолютный путь к файлу скрипта, выполняющего системные операции над БД (например, расстановка прав пользователей для объектов БД). Этот системный скрипт выполняется только в том случае, если все пользовательские скрипты были успешно протестированы и применены.
    DefaultDBFileName     - имя файла БД, содержащегося в архиве ( этот параметр нужен для того, чтобы программно можно было обращаться к файлу Бд после распаковки,
                            поскольку в общем случае имя архива и содержащегося в нём файла БД не совпадают )


[Useless Sections] - служебная секция, содержащая перечень секций не используемых для тестирования и применения скриптов

    TestParams='Test Params'
    UselessSections='Useless Sections'


/*** КОММЕНТАРИИ ***/

   Для того, чтобы тестировать и применять скрипты сразу к нескольким файлам БД, вам достаточно просто добавить ( скопировать и вставить ) и настроить необходимое кол-во секций
ИДЕНТИЧНЫХ по  структуре секции [DonNU Test] в тело ini-файла. Имена добавляемых секций - ПРОИЗВОЛЬНЫЕ ( могут дублироваться, но не рекомендуется ), но их структура - набор параметров
и их названия - СТРОГО ФИКСИРОВАНЫ.Если какую-то из уже существующих секций вы хотите деактивировать ( т.е. чтобы она не обслуживалась и настройки из неё не считывались ) - просто добавьте
её имя в секцию [Useless Sections].Скрипты не копируются на локальную станцию, а применяются и переименовываются "на месте".
По указанным путям программа автоматически забирает актуальный архив файла Бд, копирует его на локальную станцию, раскручивает, тестирует, применяет и переименовывает нужные скрипты.

Программа поддерживает 2 режима запуска, которые задаются такими параметрами коммандной строки:
   
   "cmd" - безинтерфейсный режим: программа выполняется, как отдельный процесс. Оконные или другие элементы интерфейса полностью отсутствуют.
   "win" - интерфейсный режим: программа выполняется в обычном оконном режиме.

Т.е. создав с помощью планировщика задач соответствующее расписание для исполняемого файла приложения, можно автоматизировать процесс тестирования, переименования и применения скриптов.
Пример вызова автомата с параметрами: <путь к exe-файлу> "пробел" "имя параметра" 

В независимости от режима вызова:

програма выводит на экран сообщение о результатах своей работы. Если критические для выполнения программы параметры
ini-файла не заданы или заданы некорректно, то программа также сообщит об этом. Программа также ведёт лог собственных ошибок, который находится
в том же каталоге, что и исполняемый файл. Кроме того для каждого из файлов скриптов создаётся лог-файл в случае, если он был
выполнен с ошибками. Причём лог-файлы создаются для одного и того же файла скрипта отдельно при тестировании ( имя лог-файла содержит слово "TEST" ) и применении( имя лог-файла содержит слово "EXEC" ) его к "живой БД". Это 
нужно для того, чтобы отследить те скрипты, которые были успешно протестированы, но которые были применены с ошибками к "живой БД".

Формат именования лог-файлов: <символ обнаружения ошибки> <куда применялся скрипт> <символ обнаружения ошибки> <тип результата применения скрипта> <символ обнаружения ошибки> <имя ошибочного скрипта> .log

Например:
          #B#TEST#2005-11-20=08==BCDS==____==Naidenov==metadata.log Скрипт 2005-11-20=08==BCDS==____==Naidenov==metadata.sql был оттестирован с ошибками в Бухгалтерию.

          #D#EXEC#2005-09-03=26==BCDS==B___==B01==Gavriluk==metadata.log Скрипт 2005-09-03=26==BCDS==B___==B01==Gavriluk==metadata.sql был применён с ошибками в Днепродзержинск.

В случае безинтерфейсного вызова программы, по окончанию её работы на экран выводится соответствующее сообщение + создаются лог-файлы по каждому из скриптов.

В случае интерфейсного вызова программы, по окончанию её работы на экран выводится соответствующее сообщение + по каждому из скриптов создаются лог-файлы и экранные сообщения в виде строки, указывающей на результат тестирования(применения) данного скрипта.


/*** ПРОСЬБЫ ***/

   1. БудЬте ОЧЕНЬ ВНИМАТЕЛЬНЫ при указании путей и прочих настроек;
   2. Не забывайте УДАЛЯТЬ файлы БД и соответствующие архивы по пути DBPathCopyTo="...", чтобы не накапливать версии файлов БД и их архивов.
   3. Именуйте файлы скриптов в едином регистре. Программа РЕГИСТРОЧУВСТВИТЕЛЬНА.