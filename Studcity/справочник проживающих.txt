 
 - вызов справочника не изменился;
 - подключение справочника не изменилось;
 - подключены ВСЕ хранимые процедуры (по расчету сумм и разбивке по сметам);
 - возвращается разбивка по смета-раздел-статья-кекв в идентификаторах (а не по номерам, как было раньше) ;
 - возвращение параметров и результатов работы возвращается вариантным массивом;
 - гарантируется работа справочника ТОЛЬКО НА СЕГОДНЯШНЕЙ ВЕРСИИ БАЗЫ - скрипты уже залиты;
 - исправлены данные по проживающим в базе, которые были завязаны на номерах смета-раздел-статья-кекв.


...
var
  ResOpl:Variant;
begin
 ResOpl:= Load_st_BuildLivers(self,DataModule1.pFIBDatabase1.Handle,false);
if VarArrayDimCount(ResOpl)>0 then .....


Возвращаемые значения :
1) Первый уровень массива - кол-во ячеек массива не изменяется:
ResOpl[0][0] - идентификатор проживающего
ResOpl[0][1] - дата начала проживания
ResOpl[0][2] - дата окончания проживания
ResOpl[0][3] - сумма калькуляции за весь период проживания
ResOpl[0][4] - уже уплаченная проживающим сумма 
ResOpl[0][5] - остаток, который необходимо заплатить проживающему
ResOpl[0][6] - дата, по которую уплачено проживающим
ResOpl[0][7] - дата, по которую будет произведена оплата
ResOpl[0][8] - сумма, которую вносят за проживание (эта сумма разбивается по сметам)
ResOpl[0][9] - количество записей в таблице разбивки этой суммы

Допустим, все заполнено корректно и справочник "сработал". 
Тогда:
- кол-во строк результирующего вариантного массива будет увеличено на число, равное кол-ву записей в
  таблице разбивки суммы по смета-раздел-статья-кекв;
- чтобы определить число строк в массиве, необходимо к ResOpl[0][9] прибавить 1, т.е. ResCount = ResOpl[0][9]+1;

В этом случае имеем второй, третий ...... уровни массива, число которых зависит от конкретной разбивки.
2) Структура полученных уровней массива
ResOpl[i][0] - идентификатор сметы
ResOpl[i][1] - идентификатор раздела
ResOpl[i][2] - идентификатор статьи
ResOpl[i][3] - идентификатор кекв
ResOpl[i][4] - сумма

где i - текущий уровень массива

Пусть справочник "сработал". И полученная сумма разбита, допустим, по ТРЁМ (3) смета-раздел-статья-кекв.

...
var
  ResOpl:Variant;
begin
 ResOpl:= Load_st_BuildLivers(self,DataModule1.pFIBDatabase1.Handle,false);
if VarArrayDimCount(ResOpl)>0 then .....


1) Определяем кол-во уровней массива
....
RecordsOfRes:= ResOpl[0][9]+1; // кол-во уровней = 4 (1-н статический и 3-и полученных по разбивке)

2) Делаем необходимые действия над результатами
....

// действия над статической частью массива (общие данные о проживающем)
.........
ShowMessage(VarToStr(ResOpl[0][0]));
ShowMessage(VarToStr(ResOpl[0][1]));
ShowMessage(VarToStr(ResOpl[0][2]));
.........

// действия над динамической частью мамассива (разбивка вносимой суммы, которая у каждого проживающего может изменяться)


for i:=1 to RecordsOfRes-1 do begin
ShowMessage(VarToStr(ResOpl[i][0])); // смета
ShowMessage(VarToStr(ResOpl[i][1])); // раздел
ShowMessage(VarToStr(ResOpl[i][2])); // статья
ShowMessage(VarToStr(ResOpl[i][3])); // кекв
ShowMessage(VarToStr(ResOpl[i][4])); // сумма разбивки (часть суммы, вносимой для уплаты)
end;

Матрица разбивки в этом случае 3х3 :
см1 разд1 ст1 кекв1 сумма1
см2 разд2 ст2 кекв2 сумма2
см2 разд2 ст2 кекв2 сумма2

ВСЁ.

Чернявский А.Э.




